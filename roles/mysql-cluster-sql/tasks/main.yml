- name: Download and Extract Mysql Sql Cluster binaries
  unarchive:
    src: "http://dev.mysql.com/get/Downloads/MySQL-Cluster-7.3/mysql-cluster-gpl-7.3.4-linux-glibc2.5-x86_64.tar.gz"
    dest: /var/tmp
    remote_src: yes
  become: true

- name: Extract binaries
  command: tar -C /usr/local -xzf /var/tmp/mysql-cluster-gpl-7.3.4-linux-glibc2.5-x86_64.tar.gz
  args:
    creates: /usr/local/mysql-cluster-gpl-7.6.9-linux-glibc2.5-x86_64
  become: true

#- name: Link binary directory to short name
#  command: ln -s /usr/local/mysql-cluster-gpl-7.6.9-linux-glibc2.5-x86_64 /usr/local/mysql
- name: Create /usr/local/mysql directory
  file:
    path: /usr/local/mysql
    state: directory
  become: true

- name: Create symlink for /usr/local/mysql
  file:
    src: /usr/local/mysql-cluster-gpl-7.6.9-linux-glibc2.5-x86_64
    dest: /usr/local/mysql
    state: link
  become: true

#- name: Create mysql group
#  group: name=cacheuser system=yes

#- name: Create myslq user
#  user: name=cacheuser system=yes createhome=no group=cacheuser

# Create database privileges
#- name: Create mysql cacheuser
#  mysql_user:
#    name: cacheuser
#    password: 12345
#    priv: '*.*:ALL'
#    state: present

#- name: Install mysql DB
#  command: ./scripts/mysql_install_db --user=cacheuser chdir=/usr/local/mysql/ creates=/usr/local/mysql/data/mysql/user.frm

#- name: Set permissions
#  shell: chown -R cacheuser /usr/local/mysql/data && chgrp -R cacheuser /usr/local/mysql/

#- name: Install init file
#  command: install /usr/local/mysql/support-files/mysql.server /etc/init.d/ creates=/etc/init.d/mysql.server

#- name: Install config
#  template: src=my.cnf dest=/etc/my.cnf

#- name: Activate init script and start mysql server
#  service: name=mysql.server enabled=yes state=started

#- name: Alter tables to allow user replication
#  command: /usr/local/mysql/bin/mysql -e 'ALTER TABLE mysql.{{ item }} ENGINE=NDBCLUSTER;' creates=/usr/local/mysql/data/mysql/{{ item }}.ndb
#  with_items:
#  - user
#  - db
#  - tables_priv
#  - columns_priv
#  - procs_priv
#  - proxies_priv

# Create database privileges
#- mysql_user:
#    name: cacheuser
#    password: 12345
#    priv: '*.*:ALL'
#    state: present

# TEST
#- name: import Cachecluster database
#  mysql_db:
#    name: CacheCluster
#    state: import
#    target: /etc/ansible/mysql/CacheCluster_2019.sql
#    login_host: localhost
#    login_user: root
#    login_password: '123456'
#    delegate_to: "{{ groups['mysql_cluster_sql'] }}" # {{ item }}
#    with_items:
#      - "{{ groups['mysql_cluster_sql'] }}"
